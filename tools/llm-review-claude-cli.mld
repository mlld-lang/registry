---
description: LLM review using Claude CLI
author: mlld-registry
version: 1.0.0
---

# Import environment variables
@import { PR_NUMBER, REPO_OWNER, REPO_NAME, PR_TITLE, PR_AUTHOR, ANTHROPIC_API_KEY } from @input

# Get PR data using GitHub CLI
@exec get_pr_data = @run [gh api repos/@REPO_OWNER/@REPO_NAME/pulls/@PR_NUMBER]
@run @get_pr_data()

# Create review prompt
@text review_prompt = [[
You are reviewing PR #{{PR_NUMBER}} "{{PR_TITLE}}" by @{{PR_AUTHOR}} for the mlld PUBLIC module registry.

Please review and respond with one of: APPROVE, REQUEST_CHANGES, or COMMENT

Then provide detailed reasoning about:
- What the module does
- Why you made this decision
- Any security concerns
- Suggestions for improvement

Be thorough but concise. Remember: this is a PUBLIC registry, so quality and security matter.
]]

# Debug: Show that we have the API key
@run [echo "API Key present: ${ANTHROPIC_API_KEY:+yes}"]

# Use Claude CLI and capture the response!
# Note: Using 2>&1 to capture both stdout and stderr
@text llm_response = @run [ANTHROPIC_API_KEY=@ANTHROPIC_API_KEY claude -m claude-3-5-sonnet-20241022 -M 1500 "@review_prompt" 2>&1]

# Debug: Show what we got
@run [echo "Claude response length: ${#llm_response}" | head -20]
@run [echo "First 200 chars of response: @llm_response" | head -c 200]

# Extract the recommendation from Claude's response (first line should be APPROVE/REQUEST_CHANGES/COMMENT)
@text recommendation = @run [echo "@llm_response" | head -1 | grep -oE "(APPROVE|REQUEST_CHANGES|COMMENT)" || echo "COMMENT"]

# Extract the reasoning (everything after the first line)
@text reasoning = @run [echo "@llm_response" | tail -n +2]

# Fallback if response is empty
@run [test -z "@llm_response" && echo "WARNING: Claude response was empty!" || true]

# Set GitHub Actions environment variables
@run [echo "LLM_RECOMMENDATION=@recommendation" >> $GITHUB_ENV]
@run [echo "LLM_REVIEW_REASONING<<EOF" >> $GITHUB_ENV]
@run [echo "@reasoning" >> $GITHUB_ENV]
@run [echo "EOF" >> $GITHUB_ENV]

# Log the review
@add [[ðŸ¤– **LLM Review Complete**

**Recommendation**: {{recommendation}}

{{reasoning}}]]