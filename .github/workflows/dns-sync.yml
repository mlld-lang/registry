name: DNS Sync on Merge

on:
  push:
    branches:
      - main
    paths:
      - 'modules.json'

jobs:
  validate-and-sync:
    runs-on: ubuntu-latest
    
    # Only run if the push is to main (not a PR)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Validate modules
      run: |
        cd registry
        node tools/validate.js --skip-content
        
    - name: Sync DNS records
      env:
        DNSIMPLE_TOKEN: ${{ secrets.DNSIMPLE_TOKEN }}
        DNSIMPLE_ACCOUNT_ID: ${{ secrets.DNSIMPLE_ACCOUNT_ID }}
      run: |
        cd registry
        node tools/dns-sync.js
        
    - name: Commit DNS sync results
      run: |
        cd registry
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        
        if [[ -n $(git status -s dns/records.json) ]]; then
          git add dns/records.json
          git commit -m "chore: update DNS sync manifest [skip ci]"
          git push
        else
          echo "No changes to DNS records manifest"
        fi
        
    - name: Create sync summary
      if: always()
      run: |
        echo "## DNS Sync Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ -f registry/dns/records.json ]; then
          echo "### Updated Records" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
          cat registry/dns/records.json | jq '.records[] | select(.action != "unchanged")' >> $GITHUB_STEP_SUMMARY || echo "No changes"
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        else
          echo "DNS sync did not complete successfully" >> $GITHUB_STEP_SUMMARY
        fi